# Auto-Updater

Use Tauri's built-in updater plugin to check for and apply updates from GitHub releases.

## How It Works

1. On app launch, check a JSON endpoint hosted on GitHub releases for the latest version
2. If newer version exists, show a toast/banner in the status bar
3. User clicks "Update" → downloads update bundle, applies it, restarts

```
GitHub Release
  ├── aTerm_X.Y.Z_aarch64.dmg    ← First install (existing)
  ├── aTerm.app.tar.gz            ← Signed update bundle (new)
  └── latest.json                 ← Version manifest (new, auto-generated by Tauri)

App launch → fetch latest.json → compare versions → download .tar.gz → apply → restart
```

## Implementation

### 1. Add Plugin

```bash
npm run tauri add updater
```

This adds `tauri-plugin-updater` to Cargo.toml and `@tauri-apps/plugin-updater` to package.json.

### 2. Generate Signing Keypair

Tauri uses a separate Ed25519 keypair (not Apple codesigning) to verify update integrity.

```bash
npx tauri signer generate -w ~/.tauri/aterm.key
```

Save the public key for `tauri.conf.json`. Store private key securely — needed at build time.

### 3. Configure `tauri.conf.json`

```json
{
  "plugins": {
    "updater": {
      "pubkey": "<PUBLIC_KEY_FROM_STEP_2>",
      "endpoints": [
        "https://github.com/saadnvd1/aTerm/releases/latest/download/latest.json"
      ]
    }
  }
}
```

### 4. Set Build Environment

The release script needs to export the private key so Tauri generates the signed update bundle + `latest.json`:

```bash
export TAURI_SIGNING_PRIVATE_KEY=$(cat ~/.tauri/aterm.key)
export TAURI_SIGNING_PRIVATE_KEY_PASSWORD=""  # or the password if set
```

Add these to `scripts/release.sh` before `npm run tauri build`.

### 5. Update Release Script

After build, Tauri will output additional files alongside the DMG:
- `aTerm.app.tar.gz` — the update bundle
- `aTerm.app.tar.gz.sig` — the signature

Attach both to the GitHub release alongside the DMG:

```bash
gh release create "v${VERSION}" \
  --title "aTerm v${VERSION}" \
  --generate-notes \
  "src-tauri/target/release/bundle/dmg/aTerm_${VERSION}_aarch64.dmg" \
  "src-tauri/target/release/bundle/macos/aTerm.app.tar.gz" \
  "src-tauri/target/release/bundle/macos/latest.json"
```

### 6. Frontend — Check + Prompt

Add update check logic in `App.tsx` or a dedicated `useAutoUpdater` hook:

```typescript
// src/hooks/useAutoUpdater.ts
import { check } from "@tauri-apps/plugin-updater";
import { relaunch } from "@tauri-apps/plugin-process";

interface UpdateState {
  available: boolean;
  version: string;
  body: string;       // release notes
  downloading: boolean;
  progress: number;    // 0-100
}

export function useAutoUpdater() {
  // Check on mount (with a small delay to not block startup)
  // If update available, set state
  // Expose install() that calls update.downloadAndInstall() + relaunch()
}
```

### 7. UI — Status Bar Banner

Show update availability in the existing `StatusBar` component:

```
┌─────────────────────────────────────────────┐
│ aTerm v0.1.25 available  [Update & Restart] │
└─────────────────────────────────────────────┘
```

- Subtle, non-blocking — just a small section in the status bar
- Click "Update & Restart" to download + apply + relaunch
- Show download progress inline while downloading

## Files to Modify

| File | Change |
|------|--------|
| `src-tauri/tauri.conf.json` | Add updater plugin config with pubkey + endpoint |
| `src-tauri/Cargo.toml` | Plugin dependency (added by `tauri add`) |
| `package.json` | JS dependency (added by `tauri add`) |
| `src-tauri/src/lib.rs` | Register updater plugin |
| `scripts/release.sh` | Export signing key env vars, attach update bundle to release |
| `src/hooks/useAutoUpdater.ts` | **New** — check for updates, manage download state |
| `src/components/StatusBar.tsx` | Show update banner when available |

## Notes

- First install still uses DMG — auto-updater only works for existing installs
- Updates replace the `.app` in place, no reinstall needed
- Check frequency: once on app launch (with 3s delay) is sufficient
- No server needed — reads directly from GitHub releases
- The `latest.json` format is specific to Tauri and auto-generated during build
